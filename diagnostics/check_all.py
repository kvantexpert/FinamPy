#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã
"""

import logging
import sys
import time
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –ø–∞–ø–∫—É –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–æ–≤
sys.path.insert(0, str(Path(__file__).parent.parent))

from core.connection import FinamConnection
from core.currency_monitor import CurrencyMonitor
from config.settings import LOG_DIR

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(LOG_DIR / 'diagnostics.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger('Diagnostics')

def check_system():
    """–ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã"""
    
    print("\n" + "=" * 70)
    print("üî¨ –ü–û–õ–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´")
    print("=" * 70)
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Python
    print(f"\nüêç Python: {sys.version}")
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
    print("\nüì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤:")
    modules = ['FinamPy', 'colorama', 'tabulate']
    for module in modules:
        try:
            __import__(module)
            print(f"   ‚úÖ {module}")
        except ImportError as e:
            print(f"   ‚ùå {module}: {e}")
    
    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–ø–æ–∫
    print("\nüìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫:")
    paths = [
        Path(__file__).parent.parent,
        LOG_DIR,
    ]
    for path in paths:
        if path.exists():
            print(f"   ‚úÖ {path}")
        else:
            print(f"   ‚ùå {path} (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)")
    
    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    print("\nüîå –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Finam...")
    conn = FinamConnection()
    
    if conn.connect():
        # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
        results = conn.run_diagnostics()
        conn.print_diagnostic_summary()
        
        # 5. –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        print("\nüì° –¢–µ—Å—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (5 —Å–µ–∫—É–Ω–¥)...")
        monitor = CurrencyMonitor(conn)
        monitor.start()
        
        # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
        for i in range(5):
            time.sleep(1)
            print(f"   {i+1}... –ø–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {monitor.update_count}")
        
        monitor.stop()
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if monitor.update_count > 0:
            monitor.print_table()
        
        conn.disconnect()
    else:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Finam")
    
    print("\n" + "=" * 70)
    print("‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê")
    print("=" * 70)

if __name__ == "__main__":
    check_system()